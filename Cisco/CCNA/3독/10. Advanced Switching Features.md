
## VLAN Trunking Protocol

The VLAN Trunking Protocol (VTP) is a proprietary Cisco protocol used to share virtual local area network network (VLAN) configuration information bewteen Cisco switches on trunk connections. VTP enables swtiches to share and synchronize their VLAN information, which ensures that your network has a consistent VLAN configuration.

### VTP Modes

There are three modes for VTP: client, server and transparent.

| Desc                                | Server | Client | Trans |
| ----------------------------------- | ------ | ------ | ----- |
| Can add, modify, and delete VLANs   | Y      | N      | Y     |
| Can generate VTP messages           | Y      | N      | N     |
| Can propagate VTP messages          | Y      | Y      | Y     |
| Can accept changes in a VTP message | Y      | Y      | N     |
| Default VTP mode                    | Y      | N      | N     |
| Saves VLANs to NVRAM                | Y      | N      | Y     |

Configuration changes made to a transparent switch affect only *that* switch and no other switch in the network. A VTP server swicth, however, will make the change and then propagate a VTP message concerning the change to all of its trunk ports.
If a server switch receives a VTP message, it will incorporate the update and forward the message out its remiaining trunk ports. A transparent switch, on the other hand, ignores VTP messages (just forward to them).

A VTP client switch cannot make changes to its VLAN configuration itself, it requires a server switch to tell it about the VLAN changes. when a client switch receives a VTP message from a server switch, it incorporates the changes and then floods the VTP messages.

### VTP Messages

If you use a client/server configuration for VTP, these switches can generate three types of VTP messages: Advertisement request, Subset advertisement, and summary advertisement.

* **Advertisement request**
	* Client generates to acquire VLAN information.
* **Subset advertisement**
	* Respond for advertisement request that generates from client
	* contains detailed VLAN configuration information (VLAN numbers, names, types, and other information).
* **Summary advertisement**
	* Generated by server in every 5 minutes (300 seconds).
	* contains only summarized VLAN information

Switches in either server or client mode will process VTP messages if they are in the same VTP domain; however, some restrictions are placed on whether the switch should incorporate the changes or not.

One function of the VTP summary advertisements is to ensure that all of the switches have the most current changes. If you didn't make a change on a server switch in the five-minute update interval, when the countdown timer expires, the server switch still sends out a summary advertisement with the same exact summary information. To make this process more efficient, the *configuration revision number* is used to keep track of what server switch has the most recent changes. If you make a change on a server switch, it increments its revision number and advertises this to the other switches across its trunk links.

If a server switch receives a VTP message from another sever, and the advertising server has a lower revision number, the receiving server switch will respond to the advertising server with a VTP message with its current configuration reivision number.

### VTP Pruning

VTP pruning is enables your switches to delete or add VLANs to a trunk dynamically.

By default, all VLANs are associated with a trunk connection. This means that if a device in *any* VLAN generates a broadcast, a multicast, or an unknown unicast, the switch will flood this frame out all ports associated with the source VLAN port, including trunks. It doesn't make sense to flood a frame to a neighboring switch if that switch doesn't have any active ports in the source VLAN.

#### Trunking Without Pruning

![[Pasted image 20251216115113.png]]

* VTP pruning is not enabled
* PC-A, PC-B, PC-E and PC-F is in the same VLAN
* PC-C, and PC-C is in the same VLAN

If PC-A generates a broadcast, Switch A will forward this to the access link to which PC-B is connected as well as the trunk (since a trunk is a member of all VLANs, by default). This makes sense, since PC-E and PC-F, connected to SwitchB, are in the same VLAN.

If PC-C generates a local broadcast, SwitchA will forward this t PC-D's port and will flood this broadcast out its trunk port to Switch B. This is an example of wasting bandwidth and resources.

You could use of two methods to fix this problem: static VLAN pruning or dynamic VLAN pruning.

#### Trunking with Pruning

The VTP pruninig feature enables the switches to share additional VLAN information and to prune inactive VLANs dynamically from trunk connections.

For example, SwitchA tells SwitchB that it has two active VLANs. SwitchB, on the other hand, has only one active VLAN, and it shares this fact with SwitchA. Given this shared information, both SwitchA and SwitchB realize that one of VLAN is inactive across their trunk conneciton, and therefore inactive VLAN should be dynamically removed from the trunk's configuration.

Only a VTP switch in *server* mode can enable VTP pruning, and the remaining switches in the domain must be either in VTP server or client mode. If you have transparent mode switche, you'll have to prune VLANs off their trunk links manually.

### Management VLAN

During the configuration, all VLAN commands refer to the VLAN number, even though you can configure an optional name for the VLAN. Every port on your switch, by default, is associated with VLAN 1. And all communications from the switch itself (VTP messages, CDP multicasts, and other traffic the switch originates) occur in VLAN 1.

VLAN 1 is sometimes called the *management* VLAN, even though you can use a different VLAN. It is common practice to put all of your management devices in their own VLAN. If you decide to put your switch in a different VLAN than VLAN  1, it is recommended that you can change this configuration on all your management devices so that you can more easily secure them; and on this layer 3 devices, you can set up access control lists to filter unwanted traffic.

It's important that all your switches are in the same management VLAN, since many of the switches' management protocols, occur within the switch's management VLAN.

### Configuring VTP

| VTP Component | Default value |
| ------------- | ------------- |
| Domain name   | None          |
| Mode          | Server        |
| Password      | None          |
| Pruning       | Disabled      |
| Version       | 1             |

```
### defines domain name for switch
# in order for switches to share VTP information, they must be in the same domain.
# If you omit this, the switch will learn this from a server advertisement
Switch(config)#vtp domain VTP_DOMAIN

### defines vtp mode (default: server)
Switch(config)#vtp mode server|client|transparent

### Configure VTP MD5 password
# must match the password configured on every switch in the domain
Switch(config)#vtp password VTP_PASS

### enable pruning
Switch(config)#vtp pruning

### verify VTP
Switch#show vtp status

### display vtp statistics
Switch#show vtp counters
```

### Ex 10-1: Working with VTP

```
### set trunk port
VAN-SW1(config-if)#switchport mode trunk

### VTP configuration
VAN-SW1(config)#vtp domain lab
VAN-SW1(config)#vtp mode server
VAN-SW1(config)#vtp password vtppass
VAN-SW1(config)#vtp pruning

### verify vtp
VAN-SW1#show vtp status

### display vtp statistics
VAN-SW1#show vtp counters

### create vlans
VAN-SW1(config)#vlan 2
VAN-SW1(config-vlan)#name Sales
VAN-SW1(config-vlan)#vlan 3
VAN-SW1(config-vlan)#name Mkt

### verify vlan
VAN-SW1#show vlan

### place interfaces in vlan
VAN-SW1(config)#interface g1/0/5
VAN-SW1(config-if)#switchport mode access
VAN-SW1(config-if)#switchport access vlan 2

### verify interface placement
VAN-SW1#show vlan
```

---

## Spanning Tree Protocol

The main function of STP is to remove layer 2 loops from your topology.

### Bridge Protocol Data Units

For STP to function, the switches need to share information about themselves and their connections. What they share are Bridge Protocol Data Units (BPDUs), which are sent out as *multicast* frames to which only other layer 2 switches or bridges are listening.

To prevent loops on the network, the switches will logically disable a port or portss in the topology to ensure that there are no loops.

By default, BPDUs are sent out every two seconds. This helps speed up convergence. *Convergence* is a term used in networking to describe the amount of time it takes to deal with changes and get the network back up and running. Setting the BPDU advertisement time to two seconds in the network, reducing the amount of time any disruption would create.

BPDUs contain a lot of information to help the switches determine the topology and any loops that result from that topology. For instance, each bridge has a unique identifier, called a *bridge* or *switch ID*. This is typically the priority of the switch and the MAC address of the switch itself. When a switch advertises a BPDU, it places its switch ID in the BPDU so that a receiving switch can tell from which switch it is receiving topology information.

### Root Switch

A spanning tree is created first. Basically, a spanning tree is an inverted tree. At the top of the tree is the root, or what is referred to in STP as the *root switch* or *bridge*. From the root switch, branches (physical Ethernet connections) extend and connect to other switches, then branches from these switches connect to other switches, and so on.

The very first step in STP is to elect the root switch. BPDUs are used for the election process.
The switch with the *lowest switch ID* is chosen as root. The switch ID is made up of two components:

* The switch's priority, which defaults to 32,768 on Cisco switches (2 bytes in length)
* The switch's MAC address (6 bytes in length)

The election process of the root switch takes place each time a topology change occurs in the network, such as the failure of a root switch or the addition of a new switch.

### Root Port

After the root switch is elected, every other switch in the network need to choose a single port on itself that it will use to reach the root. This port on each switch is called the *root port*.

If multiple port choices are available, an intelligent method needs to be used to choose the best port. With STP, a few factors are taken into consideration when choosing the root port.

#### Port Costs and Priorities

First, each port is assigned a *port cost*. The lower the cost, the more preferable the port. The cost is an inverse reflection of the bandwidth of the port. Switches always prefer lower cost ports over higher cost ones.

| Connection Type | Cost |
| --------------- | ---- |
| 10 Gbps         | 2    |
| 1 Gbps          | 4    |
| 100 Mbps        | 19   |
| 10 Mbps         | 100  |

Each port also has a priority assigned to it, called a *port priority value*, which defaults to 32. (perfer lower priority value over a higher one).

#### Path Costs

A path cost is basically the accumulated port costs from the root switch to other switches in the topology. When the root advertises BPDUs out its interfaces, the default path cost value in the BPDU frame is 0. When a connected switch receives this BPDU, it increments the path cost by the cost of its local incoming port.

If the port was a Fast Ethernet Port (100 Mbps, cost: 19), then the path cost would be figured: 0 (root's path cost) + 19.

#### Root Port Selection

If a switch has two or more choices of paths to reach the root, it needs to choose one path and thus have one root port.

1. Choose the path with the *lowest* accumulated path cost to the root when it has a choice between two or more paths to reach the root.
2. If multiple paths to the root are available with the same accumulated path cost, the switch will choose the neighboring switch (that the switch would go through to reach the root) with the *lowest* switch ID value.
3. If multiple path all go through the same neighboring switch, it will choose the local port with the lowest priority value.
4. If the priority values are the same between the ports, the switch will choose the physically lowest numbered port on the switch.

### Designated Port

In addition to each switch having a root port, each segment also has a single port that it uses to reach the root, and this port is called a *designated port*.

For example, that a segment has two switches connected to it. Either one or the other switch will forward traffic from this segment to the rest of the network.

**Determine which port on which switch will be chosen as the designated port for a particular LAN segment:**

1. The connected switch on the segment with the lowest accumulated path cost to the root switch will be used
2. If there is a tie in accumulated path costs between two switches, the switch with the lowest switch ID will be chosen
3. If it happens that it is the same switch, but with two separate connections to the LAN segment, the switch port with the lowest priority is chosen.
4. if there is still a tie, the physically lowest numbered port on the switch is chosen.

### Port States

A port can be in one of five states when it is participating in STP:
* Blocking
* Listening
* Learning
* Forwarding
* Disabled

#### Blocking State

Ports will go into a *blocking state* under one of three conditions:

* During election of a root switch
* When a switch receives a BPDU on a port that indicates a better path to the root switch then the port which the switch is currently using to reach the root
* If a port is not a root port or a designated port

A port in a blocking state will remain there for 20 seconds by default (maximum age timer). During this state, the port is listening to and processing only BPDUs on its interfaces. Any other frames that the swtich recives on a blocked port are dropped.

In a blocking state, the switch is attempting to figure out which port is going to be the root port, which ports on the switch need to be designated ports, and which ports will remain in a blocking state to break up any loops.

#### Listening State

After the 20-second timer expires, a root port or a designated port will move to a *listening* state. Any other ports will remain in a blocking state.

During the listening state, the port is still listening for BDPUs and double-checking the layer 2 topology. Again, the only traffic is being processesd on a port in this state consists of BPDUs; all other traffic is dropped. A port will stay in this state for the length of the *forward delay timer*. The default for this value is 15 seconds.

#### Learning State

From a listening state, a root and desginated ports move into a *learning state*.

During the learning state, the port is still listening for and processing BPDUs on the port; however, unlike while in the listening state, the port begins to process user frames. But the switch is still not forwarding user frames out destination ports. Ports stay in this state for the length of the forward delay time.

#### Forwarding State

After the forward delay timer expires, port that were in a learning state are placed in a *forwarding state*.

In a forwarding state, the port will process BPDUs, update its MAC address table with frames that it receives, and forward user traffic through the port.

#### Disabled State

A port in a disabled state is not participating in STP. This could be because the port has been manually shut down by an administrator, manually removed from STP, disabled because of security issues, or rendered nonfunctional because of a lack of a physical layer signal (such as the patch cale being unplugged).

> Blocking (20 seconds): Processing only BPDUs
> Listening (15 seconds): Processing only BPDUs
> Learning (15seconds): processing BPDUs, and user traffic (not forwarding)
> Forwarding: processing BPDUs, and user traffic. also forwarding user traffic.
> 
> STP leaves ports in a blocking state to remove loops
> Disabled States are from administrator (or cable issues)

### Layer 2 Convergence

STP goes through a staged process, which *slows down* convergence.
If a port has go through all four states, convergence takes 50 seconds.

#### PortFast Overview

The faster that convergence takes place, the less disruption it will cause for users. You can reduce timers to speed up your convergence time, but it can create more problems if you aren't aware of what you are doing when you change them.

For user ports, you can use the *PortFast* feature to speed up convergence.
A port with PortFast enabled is always placed in a forwarding state. So when STP is running, PortFast ports on the same switch can still forward traffic among themselves, limiting your STP disruption somewhat. However, if these devices wanted to talk to device connected to other switches, they would have to wait until STP completed and the root and designated ports had moved into a forwarding state.

PortFast is a great option to configure when you want to use Preboot Execution Environment (PXE) boot, where the device booting is tryping to contact a DHCP server right away at bootup.

#### PortFast Configuration

```
# globaly
Switch(config)# spanning-tree portfast default

# interface-by-interface
Switch(config-if)# spanning-tree portfast [trunk]
```

The optional `trunk` parameter enables PortFast on trunk connections to non-switche devices, such as a router or server with a trunk card.

#### BPDU Guard Feature

If a PortFast port receives a BPDU, the switch immediately disalbes the port. The assumption is that a PortFast port is not connected to a switch and therefore shouldn't be receiving BPDUs.

```
### enable bpdu guard globally
Switch(config)# spanning-tree portfast bpduguard

### verify bpdu guard
Switch# show spanning-tree summary totals
```

When a port has been placed in an error disabled state, use the `errdisable recovery cause bpduguard` command to remove the error disabled state.

Optionally you can have the switch periodically do this by configuring the command with an interval, specified in seconds:

```
Switch(config)# errdisable recovery interval SECONDS
```

### Per-VLAN Spanning Tree+ (PVST+)

When one instance of STP is running, this is referred to as a *Common Spanning Tree (CST)*. Cisco also supports a process called *Per-VLAN Spanning Tree Plus (PVST+)*. With PVST+, each VLAN has its own instance of STP, with its own root switch, its own set of priorities, and its own set of BPDUs. In this scenario, the BPDUs have an addtional field that is a component of the switch or bridge ID with these three subfields: switch priority, extended system ID, and the switch's MAC address. The extended system ID is a new field and carries the VLAN ID (VID) for the instance of STP.

With the addition to this field, it is possible to have different priorities on switches in different VLANs; thus you have the capability of having multiple root switches (one per VLAN). Each VLAN in PVST+, by default, will develop its own loop-free network; however, you can make STP changes in *each* VLAN to optimize traffic patterns for each separate VLAN. It is higly recommended that you tune STP for each VLAN to optimize it.
Another advantage that PVST+ has is that if STP changes are occurring in one VLAN, they do not affect other instances of STP for other VLANs, making for a mor stale topology.

The downside of PVST+ is that because each VLAN has its own instance of STP, more overhead is involved. Plus it makes no sense to use PVST+ unless you tune it for your network, which means more work and monitoring on your part.

### Simple STP Example

![[Pasted image 20251222174838.png]]

Assume that these switches do not support Rapid STP (RSTP), but only 802.1d STP. Also assume that there is only one VLAN.

#### Electing the Root Switch

The switches share BPDUs with one another to elect the root. In this example, all of the switches are using the default priority. Since all of the switches have the same priority, the switch with the lowest MAC address, which is Switch-1, is chosen as the root switch.

![[Pasted image 20251222181241.png]]

#### Choosing Root Ports for Each Switch

After the root switch is elected, each non-root switch must choose a root port that it will use to reach the root.

Switch-2 has two ports to use to reach the root: E and F. When Switch-1 generates its BPDUs on port I and J, the original path cost is set to 0. As these BPDUs are received by other switches, the receiving switch increments the path cost by the cost of the port on which the BPDU was recived. As the BPDU comes into port E, Switch-2 increments the path cost to 20, and for port F, a cost of 10. Port F has the best path cost and therefore is chosen as the root port.

![[Pasted image 20251222182441.png]]

#### Choosing Designated Ports for Each Segment

After the root ports are chosen, each switch will figure out, on a segment-by-segment basis, whether its connected to the segment should be a desginated port or not.

Remeber, that the designated port on a segment is responsible for moving traffic back and forth between the segment and the rest of the layer 2 network. The segment themselves, of course, are completely unaware this process of choosing a designated port, the switches are figuring this out.

When choosing a designated port, the first thing is examined is the accumulated path cost for the switch (connected to the segment) to reach the root.

LAN segment B is root switch has the lowest path cost (0), its local port (J) becomes the designated port for LAN segment-B. This process is also true for LAN segment-C, making port I on switch-1 the designated port for LAN segment-C.

LAN Segment-A has two choices: Switch-3's port D and Switch-4's port H. Switch-3 has the lower path cost. Therefore, Switch-3's port D becomes the desginated port for LAN Segment-A.

![[Pasted image 20251222183102.png]]

#### Changing Port States

Switches will move their root and desginated ports through the various states (blocking, listening, learning, and forwarding). whereas any other ports will remain in a blocking state.

![[Pasted image 20251222183314.png]]

---

## Rapid Spanning Tree Protocol

RSTP is an IEEE standard, defined in 802.1w, which is interoperatable with 802.1d and an extension to it. With RSTP, there are only three port states:

* Discarding
* Learing
* Forwarding

A port in a discarding state is basically the grouping of 802.1d's blocking, listening, and disabled states.

### Addtional Port Rules

With RSTP, there is still a root switch and there are still root and designated ports, performing the same roles as those in 802.1d. However, RSTP adds two addional port types: *alternative ports* and *backup ports*.

An alternative port has an alternative path or paths to the root but is currently in a discarding state.
A backup port is on a segment that could be used to reach the root, but an active port is already designated for the segment.

Given these new port roles, RSTP calculates the final spanning tree topology the same way as 802.1d.

### RSTP BPDUs

In 802.1d, if switch didn't see a root BPDU within the maximum age time (20 seconds), STP would run, a new root switch would be elected, and a new loop-free topology would be created.
With 802.1w, if a BPDU is not recived in three expected hello periods (6 seconds), STP information can be aged out instantly and the switch consideres that its neighbor is lost and actions should be taken.

### RSTP Convergence Features

The first convergence feature allows a switch to accept inferior BPDUs.

**Accepting inferior BPDUs**
![[Pasted image 20251223233127.png]]

The root bridge is Switch-A. Both of the ports on Switch-B and Switch-C directly connected to the root are root ports. For the segment between Switch-B and Switch-C, Switch-B provides the designated port and Switch-C provides a backup port. Switch-B also knows that its designated port is an alternative port, via Switch-C from Switch-C's BPDUs.

The link between the root and Switch-B fails, Switch-B can detect this by either missing three hellos from the root port or detecting a physical layer failure.
With the inferior BPDU feature, assuming that Switch-B knows that Switch-C has an alternative port for their directly connected segment, Switch-B can notify Switch-C to take its alternative port and change it to a designated port, and Switch-B will change its designated port to a root port.

The second convergence feature is *rapid transition*. Rapid transition includes two new components: edge ports and link types.

An edge port is a port connected to an non-layer 2 device. RSTP with rapid transition of edge ports to a forwarding state is the same as PortFast. Changes in state of these ports do not affect RSTP to cause a recalculation, and changes in other port types will keep these ports in a forwarding state.

Rapid transition can take place in RSTP only for edge ports and links that are point-to-point (P2P). The link type is automatically determined in terms of the duplexing of the connection. Switches make the assumption that if the port is configured for full duplex between the two switches, the port can repidly transition to a different state without having to wait for any timers to expire. If they are half duplex, this feature won't work by default, but you can manually enable it for P2P half-duplex switch links.

**Rapid transition example**
![[Pasted image 20251223234451.png]]

Link between Switch-A (the root) and Switch-C fails. When this happens, Switch-C can no longer reach Switch-A on its root port.
However, looking at the BPDUs it has been reciving from Switch-A and Switch-B, Switch-C knows that the root is reachable via Switch-B and that Switch-B provides the designated port (which is in a forwarding state) for the segment between Switch-B and Switch-C. Switch-C, knowing this, changes the state of backup port to a root port and places it immediately into a forwarding state, notifying Switch-B of the change. This update typically takes less than a second, assuming that the failure of the segment between the root and Switch-C is a physical link failure, instaead of three missed consecutive hello BPDUs.

### RSTP Configuration

Cisco switches support three types of STP. The default configuration on Cisco switches is a separate instance of STP per VLAN, one root switch for all the VLANs, and no load sharing.

**STP Types**

| STP                                    | DESC                                                                                   |
| -------------------------------------- | -------------------------------------------------------------------------------------- |
| PVST+                                  | 802.1d per VLAN with Cisco-proprietary extensions (PortFast, UplinkFast, BackboneFast) |
| PVRST+                                 | 802.1w (RSTP) per VLAN                                                                 |
| Multiservice Transport Platform (MSTP) | 802.1s, referred to as multiple STP, combines PVST+ with IEEE standards                |

```
### enable PVRST+
Switch(config)# spanning-tree mode rapid-pvst

### verify per-VLAN basis
Switch# show spanning-tree vlan VLAN_# [detail]

### verify STP on a per-port basis
switch# show spanning-tree interfae fastethernet 1/0/5
```

### PVST+ and RSTP Optimization

![[Pasted image 20251231054944.png]]

This example shows two VLANs, numbered 1 and 2. The default behavior with Cisco's switches is that a single root switch is used for all VLANs, based on the switch with the lowest switch ID. In this instance, this is Switch-A.

Notice that based on RSTP's calculation, Switch-C disabled its port to Switch0B for oth its VLANs. The downside of this design is that of the two connections to the distribution layer, only one is being utilized on the access switch.

**PVST+ and RSTP optimized**

![[Pasted image 20251231055633.png]]

To obtain this kind of topology, however, you must tune your network, making sure that Switch-A is the root for VLAN 1 and Switch-B is the root for VLANs.

With this kind of design, you can actually utilize both of your uplink connections on your access layer switch up to the distribution layer switches.

```
### change switch's priority
Switch(config)# spanning-tree vlan VLAN_# root primary    # change to 4096
Switch(config)# spanning-tree vlan VLAN_# root secondary  # change to 8092
Switch(config)# spanning-tree vlan VLAN_# root priority_#
```

Default priority for switch is 32,768. The first command changes the switch's priority to 4096 for the specified VLAN. The second command changes the switch's priority to 8092 for the specified VLAN.

```
# Switch-A configuration
Switch-A(config)# spanning-tree mode rapid-pvst
Switch-A(config)# spanning-tree vlan 1 root primary
Switch-A(config)# spanning-tree vlan 2 root secondary

# Switch-B configuration
Switch-B(config)# spanning-tree mode rapid-pvst
Switch-B(config)# spanning-tree vlan 1 root secondary
Switch-B(config)# spanning-tree vlan 2 root primary
```

### STP Troubleshooting

Switches send broadcast messages to all ports on the switche (except the port it was recived on). If you have a layer 2 loop, that means there are multiple pathways between the switches, and the broadcast message would be rebroadcasted from one switch to another, using up bandwidth and processing power on the switchs. This is a broadcast storm.

#### Loop Identification

One indication of a broadcast storm is very high CPU and port utilization on your switches.

You can examine a switch's or several switches' CPU utilization with the `sohw processes` and `show process cpu` commands.

To verify that a layer 2 loop is causing the problem, capture and analayze traffic with a protocol analyzer to a switch and using the Switch Port Analyzer (SPAN) feature on your switch, which copies frames from an interface or VLAN to the SPAN port.

Once a loop is identified, to restore connectivity quickly, you should start disabling ports that are port of the loop; then diagnose the problem to determine whether a configuration issue on your part or the addition of a new layer 2 device is causing the problem. If you are having problems identifying what is causing the loop, turn on debug for STP (`debug spanning-tree events`).

#### Configuration Remedies

To simplify your troubleshooting process, disable as many features as necessary.

If you are not certain which switch is the root switch, log into the switch that logically should be the root and force it to become the root by changing its prirority to 1 with the `spanning-tree vlan VLAN_# priority` command.

Make sure that all your switches are running either 802.1d or 802.1w (RSTP). Use the `show spanning-tree` command to verify this as well as whether or not the switch is playing the role of root for a VLAN.

### Ex 10-2: Monitoring STP

---

## EtherChannels

### EtherChannel Overview

An EtherChannel is a layer 2 solution that enables you to aggregate multiple layer 2 Ethernet-based connections between directly connected devices.
Basically, an EtherChannel bundles together multiple Ethernet ports between devices, providing what appears to be a single logical interface.

**EtherChannel advantages**
* Redundancy
	* If one connection in the channel fails, you can use other connections in the channel
* More bandwidth
	* Each connection can be used simulatneously to send frames
* Simplified management
	* Configuration is done on the logical interface, no on each individual connection in the channel.

#### EtherChannel Restrictions

Interfaces in an EtherChannel must be configured identically: speed, duplexing, and VLAN settings must be the same.
When setting up EtherChannels, you can use up to eight interfaces bundled together:

* Up to eight FE, providing up to 800 Mbps
* Up to eight GE, providing up to 8 Gbps
* Up to eight 10GE, providing up to 80 Gbps

Typically you can have a total of six EtherChannels on a switch, but this is larger on the higer-end IOS switches.

#### EtherChannel Operations

Channels can be formed dyanamically between devices by using on of two protocols: Port Aggregation Protocol (PAgP) or Link Aggregation Control Protocol (LACP).

| Protocol | Desc                                                                                                                                                                         |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| PAgP     | Proprietary to Cisco. It enables connected devices to group similarly configured ports dynamically into a single channel                                                     |
| LACP     | Defined in the IEEE 802.3ad standard. It learns from a connected device which ports between the two are identically configured and dynamically forms a channel between them. |

Once a channel is formed, load balancing can be used by the connected devices to utilize all the ports in the channel. Load balancing can use MAC or IP addresses, source or destination addresses, or both source and destination address pairs.
With load balancing, you are guaranteed that all links in the channel will be utilized; however, you are not guaranteed that all the ports will be utilized the same.


### EtherChannel Configuration

```
Switch(config-if)# channel-group GROUP_# mode MODE
Switch(config-if)# port-channel load-balance {dst-ip | dst-mac |
                        src-det-ip | src-dst-mac | src-ip | src-mac}
```

The `group_#` specifies the channel group to which the interface belongs, which can be from 1 to 6.

**EtherChannel Modes**

| Mode      | Protocol | Desc                                                                                                                                              |
| --------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------- |
| auto      | PAgP     | Passively listens for PAgP queries from a Cisco device configured with either desirable or on. By default, the interface is not part of a channel |
| desirable | PAgP     | Generates PAgP queries to form a channel, but by default is not part of a channel                                                                 |
| on        | PAgP     | Generates PAgP queries and assumes the port is part of a channel                                                                                  |
| active    | LACP     | Enables a channel if the other side responds to its LACP messages                                                                                 |
| passive   | LACP     | Passively listens for LACP messages to form a channel from an active port.                                                                        |

Use the `port-channel load-balance` command to configure the type of load balancing you want to use on the channel. If you omit this command, it defaults to load balancing based on source MAC address (`src-mac`).

```
### Configuration example
SwitchA(config)# interface g1/0/1
# using PAgP
SwitchA(config-if)# channel-group 1 mode auto

SwitchA(config-if)# interface g1/0/2
# using PAgP
SwitchA(config-if)# channel-group 1 mode auto

### Because the auto mode is used on SwitchA, SwitchB must use either a mode of on or desirable
SwitchB(config)# interface g1/0/4
# using PAgP
SwitchB(config-if)# channel-group 1 mode on

SwitchB(config-if)# interface g1/0/5
# using PAgP
SwitchB(config-if)# channel-group 1 mode on
```

### Ex 10-3: Working with EtherChannel

```
#### VAN-SW1
VAN-SW1(config)#interface g1/0/1
VAN-SW1(config-if)#channel-group 1 mode auto
VAN-SW1(config)#interface g1/0/2
VAN-SW1(config-if)#channel-group 1 mode auto

### verify
VAN-SW1#show etherchannel summary
VAN-SW1#show interfaces port-channel 1

#### VAN-SW2
VAN-SW2(config)#interface g1/0/1
VAN-SW2(config-if)#channel-group 1 mode on
VAN-SW2(config)#interface g1/0/2
VAN-SW2(config-if)#channel-group 1 mode on

### verify
VAN-SW2#show etherchannel summary
VAN-SW2#show interfaces port-channel 1
```

---

## Review

VTP is a Cisco-proprietary protocol that transmits VLAN information across trunk ports. Switches must be in the same domain to share messages. There are three modes for VTP: client, server, and transparent.
Server and transparent switches can add, change, and delete VLANs, but server switches advertise these changes.
Client can accept updates only from server switches.
There are three VTP messages: advertisement request, subset advertisement, and summary advertisement.
Servers generate summary advertisement every five minutes on trunk connections. The configuration revision number is used to determine which server switch has the most current VLAn information.
VTP pruining is used to prune off VLANs that are not active between two switches, but it requires switches to be in server and/or client mode.

On the Cisco switche, use the `vtp domain` command and `vtp server|client|transparent` commands to configure VTP. The default mode is server.
To configure VTP password, use the `vtp password` command.

BPDUs are used by STP to learn about other neighboring switches. These are generated every two seconds as multicasts. when running STP, a root switche is elected. The switch ID is composed of a priority and the switch's MAC address.
Each switch chooses a root port to reach the root switch. Each segment has on e port on one switch that becomes a designated port, which is used to forward traffic to and from the segment.
There are five port states: blocking, listening, learning, forwarding, and disabled.

PortFast puts a port immediately into forwarding mode and should be used only on non-switch ports.
PVST+ has an instance of STP running per VLAN, this is proprietary to Cisco but standarized by IEEE with MSTP.

RSTP reduces convergence to a few seconds by having switches determine valid alternative root ports and backup designated ports that they can use when topology changes take place.
PVST+ with RSTP is enabled with the `spanning-tree mode rapid-pvst` command.

EtherChannels bundle layer 2 connections between devices, creating a single logical port from STP's perspective.Load balancing can then be performed on the ports in the channel. PAgP or LACP is used to form the channel.

If your CPU and/or port utilization is high, you may have a layer 2 loop.

---

## Questions

1.  Which VTP mode(s) can create and delete VLANs?

A. Client and server
B. Server
C. Client and transparent
D. Transparent
**E. Server and transparent**

2.  The root switch is the one elected with the `__________`.

A. lowest MAC address
B. highest MAC address
**C. lowest switch ID**
D. highest switch ID

3.  The switch port that is chosen to forward traffic for a segment is called a(n) `__________`.

A. root port
B. alternate port
C. backup port
**D. designated port**

4.  With STP, which of the following is true concerning a port that is in a listening state? (Choose two.)

**A. It remains there for 15 seconds.**
B. It forwards BPDUs and builds the CAM table. => Learning state
C. It remains there for 20 seconds. => blocking state, listening state is 15 seconds.
**D. It forwards BPDUs.**

During the listening state, the port is still listening for BDPUs and double-checking the layer 2 topology. Again, the only traffic is being processesd on a port in this state consists of BPDUs; all other traffic is dropped. A port will stay in this state for the length of the *forward delay timer*. The default for this value is 15 seconds.

5.  How many port states are there in RSTP?

**A. 3**
B. 4
C. 5
D. 6

discarding, learing, forwarding

6.  What port role will be assigned to a port that has the second-best path to the root switch?

A. Root
B. Designated
**C. Alternate**
D. Backup

With RSTP, there is still a root switch and there are still root and designated ports, performing the same roles as those in 802.1d. However, RSTP adds two addional port types: *alternative ports* and *backup ports*.

An alternative port has an alternative path or paths to the root but is currently in a discarding state.
A backup port is on a segment that could be used to reach the root, but an active port is already designated for the segment.

alternative port is backup for root port
backup port is backup for designated port

7.  Which command enables RSTP with PVRST+ on a Cisco switch?

**A. spanning-tree mode rapid-pvst**
B. spanning-tree state rapid-pvst
C. stp state rapid-pvst
D. spanning-tree mode rstp

8.  Which of the following is/are true concerning EtherChannels?

A. You can have up to six ports in a channel.
B. You can have up to eight channels on a switch.
**C. Ports must be configured identically to form a channel.**
D. RSTP dynamically groups ports into a channel.

9.  What symptom should you look for to determine whether you have a layer 2 loop?

A. High number of broadcast and/or multicast frames
**B. High port utilization**
C. User switch interfaces dropping and reconnecting
D. Port address tables not being updated

10.  What tool would you use to determine whether you had a broadcast storm caused by a layer 2 loop?

A. show interface command
**B. Protocol analyzer**
C. debug broadcast command
D. traceroute command

11.  You have two switches with VTP configured that are not connectedtogether. The first switch is running in server mode with VLANs Accounting, HR, and Executives and a configuration revision value of 55. The second switch is also running in server mode with VLANs Engineering, Sales, and Marketing and a configuration revision value of 57. You connect the two switches together with a crossover cable. What will happen? (Choose two.)

**A. If the domain names don’t match, nothing occurs.**
B. If the domain names don’t match, the VLANs on the higher revision switch are used and the other ones are deleted.
C. If the domain names match, the Engineering, Sales, and Marketing VLANs are deleted.
**D. If the domain names match, the Accounting, HR, and Executives VLANs are deleted.**

If the domain names match, it checks reivision number. higer revision number is used; the switch with the lowest reivision number will have its VLANs deleted (syncrhonized).

12. Using the following exhibit, identify characteristics of STP and EtherChannel by placing the description on the left side of the diagram into the appropriate category on the right side of the diagram. Not all descriptions found on the left will necessarily be used.

![[Pasted image 20251231124511.png]]

* **STP**
	* Designed to prevent layer 2 loops
	* Places redundant links in a blocking state
* **EtherChannel**
	* Combines bandwidth of multiple FastEthernet of Gigabit Ethernet ports
	* Allows redundancy on the links
